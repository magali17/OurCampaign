---
title: "Instrument Quality Control (QC)"
author: "Magali Blanco"
date: ' `r Sys.time()` '
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
    number_sections: true
    toc_float: true
    collapsed: false
    smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      cache=F, cache.comments = F, 
                      message = F, warning = F, 
                      tidy.opts=list(width.cutoff=60), tidy=TRUE,
                      fig.height = 5, fig.width = 8
                      )  

# # Clear workspace of all objects and unload all extra (non-base) packages
# rm(list = ls(all = TRUE))
# if (!is.null(sessionInfo()$otherPkgs)) {
#   res <- suppressWarnings(
#     lapply(paste('package:', names(sessionInfo()$otherPkgs), sep=""),
#       detach, character.only=TRUE, unload=TRUE, force=TRUE))
# }

pacman::p_load(knitr, kableExtra, 
               ggpubr, tidyverse,
               #mapping...adding scales, N arrows
               ggmap, sf, ggspatial, 
               units, #convert between e.g., m to km
               #time series data 
               lubridate
               )    
 

set.seed(1)

```

*Purpose*: This script documents the quality control procedures taken to ensure data quality after the ACT TRAP mobile monitoring campaign. 

# Upload data

common variables

```{r}
start_date <- "2019-02-22"
end_date <- "2020-03-17" #or: "2020-03-18" to capture all of 3/17 ?

pt_pollutants <- c("PM", "BC")

```

### --> add lab duplicate collocation data 

```{r}
#imports, fieldnotes, and calibraiton tables
## calibration table inlcudes calibrations for gases and zero checks for instruments
load(file.path("Data", "imports_fieldnotes_calib_tables.rda"))

#basic file w/ start/end dates
calibrations <- calibrations %>%
  # add instrument-specific data. don't include confusing timestamp, which is when files were reuploaded to database in 2021
  left_join(select(imports, -timestamp)) %>%
  #only look at calibrations soon after campaign ended. note, NO2 has some calirbations in 5/2020
  filter(endtime <= ymd(end_date)+1) %>%
  #add date
  mutate(date = ymd(substr(runname, 1,10))) %>%
  arrange(date)

lab_calibrations <- readRDS(file.path("Data", "lab_calibrations.rda"))

#all stop data
dt0 <- readRDS(file.path("Data", "stop_data_2019-02-22_2020-03-17.rda"))

```


# What instruments were used?

- filter to only keep instrument readings of interest
- ID primary and secondary instruments 
- table: variable, no_sampling_days, no_samples, start/end_date
- same as above, but by instrument_id

```{r}

```



# Calibrations

* I think the "level" column is what the instrument read, while the conc column is the true concentration during a calibration procedure. 
* pm25 should be nephelometer readings 

* **NOTE**: don't use the "analyte" column, which is wrong for some instruments (Amanda confirmed this). Use instrument_id column.

### -->  join calibration table to the results table to get the actual instrument reading

```{r}
# NOTE: don't use "analyte" column, which is wrong for some instruments??

calibrations %>%
  #drop NO and NOx data. not sure why Tim G decided to look at this
  filter(!analyte %in% c("no, nox")) %>%
  #one record per calibration attempt
  distinct(runname, analyte, instrument_id, 
           filename
           ) %>%  

  #number of times each instrument was calibrated
  group_by(#analyte, 
           instrument_id,
           #filename
           ) %>%
  summarize(
    number_of_calibrations = n(),
    dates = paste(unique(substr(runname, 1,10 )), collapse = ", ")
  ) %>%
  kable(title = "Instrument calibrations during the study period") %>%
  kable_styling()
  


```


# Zeroing inf particle intruments

note: this table doesn't actually include the calibration results, just the start/end times

### --> use lab_calibrations table to do this instead 

```{r}

# NOTE: don't use "analyte" column, which is wrong for some instruments??

calibrations %>%
  # look at particle instruments
  filter(str_detect(instrument_id, paste0("^", paste(pt_pollutants, collapse = "|")) ) ) %>%
  #some instruments had duplicate files in one day
  distinct(instrument_id, date) %>%
  group_by(instrument_id) %>%
  summarize(
    number_of_zeros = n(),
    dates = paste0(unique(date), collapse = ", ")
    
  ) %>%
  kable(caption = "when zero checks for particle instruments occurred") %>%
  kable_styling()

```


# See extreme instrument readings 

-very high vs low (e.g., pt<300; MOVUP dropped readings >27k ng/m3 - in top 1% data)
--histograms of natural break points?
-- compare against other types of instruments as well? 
- BC: check that attenuation < 50% (_atn1). Instruments are most sensitive at detecting changes below this threshold
-drop bad readings (? < 300 pt? what about other instruments??)
--note what % is dropped
-compare raw collocated instrument readings (do some instrument perform poorly?)
-save "clean" raw stop dataset

```{r}




```


# Check some time series plots to make sure there were no obvious issues

- e.g., no2 readings decreased over the course of the day? 

```{r}

```

# Check fieldnotes and instrument warnings 

-e.g., alcohol wick issues 

### --> how were makeup route runnames labeled?

```{r}
fieldnotes2 <- fieldnotes %>%
  #only look at stop data w/ notes
  filter(
    str_detect (site_id, regex("^MS|MC", ignore_case = T)),
    !is.na(notes),  
    !notes %in% c("", ".", "\\")
  )



```


# Calculate site medians

- don't include lab data here? 

-save "clean" stop medians dataset 

```{r}

```



# Compare collocated instruments 

### --> pull lab/garage collocation data from results table (see locations: LABC, RM114, WILCOXAMB that are not necessarily collocation times)

- don't include lab collocations here? 

- plot with: best fit line, MSE-based R2, RMSE, no pairs; color-coded by route?

```{r}
# lab_calibrations 

```



# ? Calibrate instrument readings to the mean

-only do this if instruments are reasonably aligned?

```{r}

```







